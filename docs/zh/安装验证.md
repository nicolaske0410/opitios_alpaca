# ✅ 安装验证指南

使用交互式验证工具和系统诊断确保您的 Opitios Alpaca 交易服务正确设置和运行。

## 🚀 快速验证

**推荐：使用自动化验证工具**

```bash
# 运行全面的设置验证器（推荐）
python docs/scripts/setup_validator.py

# 系统健康监控
python docs/scripts/health_check.py

# 基本功能测试
python test_app.py
```

## 📋 验证清单

### 必备要求验证
- [ ] **Python 3.8+**：`python --version`
- [ ] **虚拟环境**：激活并可见 `(venv)` 提示符
- [ ] **依赖包**：所有 requirements.txt 中的包已安装
- [ ] **项目结构**：所有必需文件和目录存在
- [ ] **配置**：.env 文件配置正确的 API 密钥

### 服务验证
- [ ] **服务器启动**：无错误启动
- [ ] **端口访问**：8081 端口可访问
- [ ] **API 文档**：http://localhost:8081/docs 可访问
- [ ] **健康端点**：`/api/v1/health` 返回成功
- [ ] **API 连接**：成功连接到 Alpaca API

### 功能验证
- [ ] **账户访问**：可以检索账户信息
- [ ] **市场数据**：股票报价功能正常
- [ ] **基本交易**：模拟交易订单可以执行
- [ ] **日志记录**：日志文件正确生成

## 🔍 交互式验证工具

### 设置验证器特性

**运行命令：**
```bash
python docs/scripts/setup_validator.py
```

**验证步骤：**
1. **Python 版本检查**：确认 Python 3.8+ 兼容性
2. **虚拟环境检查**：验证 venv 激活状态
3. **包依赖检查**：确认所有必需包已安装
4. **项目结构验证**：检查文件和目录结构
5. **配置验证**：验证环境变量和 API 密钥
6. **API 连接测试**：测试 Alpaca API 连通性
7. **本地服务器测试**：验证本地服务器启动

**预期输出示例：**
```
================================================================
            Opitios Alpaca Trading Service - Setup Validator
================================================================

[STEP] 1 - Checking Python version compatibility
✅ Python 3.9.7

[STEP] 2 - Checking virtual environment
✅ Active virtual environment: D:\Github\opitios_alpaca\venv

[STEP] 3 - Checking required packages
✅ All required packages are installed

[STEP] 4 - Validating project structure
✅ Project structure is correct

[STEP] 5 - Checking configuration
✅ Configuration is valid
ℹ️  ALPACA_API_KEY: ****MJAY3
ℹ️  ALPACA_SECRET_KEY: ****cret
ℹ️  ALPACA_BASE_URL: https://paper-api.alpaca.markets
ℹ️  ALPACA_PAPER_TRADING: true

[STEP] 6 - Testing Alpaca API connectivity
✅ Connected successfully. Buying power: $200000.0

[STEP] 7 - Testing local server startup
✅ Local server started successfully

================================================================
                           Validation Results
================================================================
Passed: 7/7
Success Rate: 100.0%
🎉 Excellent! Your setup is ready for production use.
```

### 健康检查工具特性

**运行命令：**
```bash
python docs/scripts/health_check.py
```

**监控项目：**
1. **服务器进程**：检查运行中的服务器进程
2. **端口可用性**：验证 8081 端口状态
3. **API 端点**：测试所有核心端点
4. **系统资源**：监控 CPU、内存、磁盘使用
5. **日志文件**：分析日志文件中的错误和警告
6. **数据库连接**：测试数据库连通性
7. **配置验证**：验证环境变量设置
8. **健康评分**：计算整体系统健康评分

**健康评分系统：**
- **90-100 分**：优秀 - 系统运行完美
- **70-89 分**：良好 - 有小问题但可用
- **< 70 分**：需要注意 - 存在重大问题

## 🛠️ 手动验证步骤

如果自动化工具不可用，请按以下步骤手动验证：

### 步骤 1：环境验证

```bash
# 检查 Python 版本
python --version
# 预期：Python 3.8.0 或更高

# 检查虚拟环境
echo $VIRTUAL_ENV  # Linux/Mac
echo %VIRTUAL_ENV%  # Windows
# 预期：显示 venv 路径

# 验证包安装
pip list | grep -E "(fastapi|alpaca|pydantic|uvicorn)"
# 预期：显示所有核心包
```

### 步骤 2：配置验证

```bash
# 检查 .env 文件存在
ls -la .env
# 预期：显示 .env 文件

# 验证 API 密钥格式（不显示实际密钥）
python -c "
import os
from dotenv import load_dotenv
load_dotenv()
api_key = os.getenv('ALPACA_API_KEY', '')
secret_key = os.getenv('ALPACA_SECRET_KEY', '')
print(f'API Key format: {\"Valid\" if api_key.startswith((\"PK\", \"AK\")) else \"Invalid\"}')
print(f'Secret Key length: {len(secret_key)} chars')
"
# 预期：API Key format: Valid, Secret Key length: 40 chars
```

### 步骤 3：服务器启动验证

```bash
# 启动服务器
python main.py &
# 预期：无错误消息，显示启动信息

# 等待几秒钟让服务器启动
sleep 5

# 测试基本端点
curl -s http://localhost:8081/api/v1/health
# 预期：{"status": "healthy", "service": "Opitios Alpaca Trading Service"}
```

### 步骤 4：API 功能验证

```bash
# 测试账户访问
curl -s http://localhost:8081/api/v1/account | head -c 100
# 预期：JSON 响应包含账户信息

# 测试股票报价
curl -s http://localhost:8081/api/v1/stocks/AAPL/quote | head -c 100
# 预期：JSON 响应包含 AAPL 报价数据

# 测试 API 文档
curl -s -o /dev/null -w "%{http_code}" http://localhost:8081/docs
# 预期：200
```

## 🚨 常见验证失败和解决方案

### 验证失败：虚拟环境未激活

**症状：**
```
❌ No virtual environment detected
```

**解决方案：**
```bash
# Windows
venv\Scripts\activate

# Linux/Mac
source venv/bin/activate

# 验证激活
echo $VIRTUAL_ENV
```

### 验证失败：缺少依赖包

**症状：**
```
❌ Missing packages: fastapi, uvicorn, alpaca-py
```

**解决方案：**
```bash
# 确保虚拟环境已激活
pip install -r requirements.txt

# 验证安装
pip list | grep fastapi
```

### 验证失败：API 连接

**症状：**
```
❌ Authentication failed - check API credentials
```

**解决方案：**
1. 验证 .env 文件中的 API 密钥
2. 检查 Alpaca 控制台中的密钥状态
3. 确认网络连接正常

### 验证失败：服务器启动

**症状：**
```
❌ Server not responding on localhost:8081
```

**解决方案：**
1. 检查端口 8081 是否被占用
2. 查看服务器启动错误日志
3. 验证防火墙设置

## 📊 性能基准测试

### 响应时间基准

运行性能测试以验证系统性能：

```bash
# 健康检查响应时间
time curl -s http://localhost:8081/api/v1/health
# 预期：< 100ms

# 账户信息响应时间
time curl -s http://localhost:8081/api/v1/account
# 预期：< 500ms

# 股票报价响应时间
time curl -s http://localhost:8081/api/v1/stocks/AAPL/quote
# 预期：< 1000ms
```

### 资源使用基准

```bash
# 检查内存使用
ps aux | grep python | grep main.py
# 预期：RSS < 100MB

# 检查 CPU 使用
top -p $(pgrep -f "python main.py") -n 1
# 预期：CPU < 5% 在空闲时
```

## 🔄 持续验证

### 自动化监控脚本

创建定期验证脚本：

```bash
#!/bin/bash
# save as validate_health.sh

echo "$(date): Starting health validation"

# 运行健康检查
python docs/scripts/health_check.py

# 检查关键端点
endpoints=("/api/v1/health" "/api/v1/account" "/docs")
for endpoint in "${endpoints[@]}"; do
    status=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8081$endpoint")
    if [ "$status" -eq 200 ]; then
        echo "✅ $endpoint: OK"
    else
        echo "❌ $endpoint: FAILED ($status)"
    fi
done

echo "$(date): Health validation completed"
```

### 设置监控计划

```bash
# 设置每小时健康检查（Linux/Mac）
crontab -e
# 添加：0 * * * * /path/to/validate_health.sh >> /path/to/health.log 2>&1

# Windows 任务计划程序
# 创建每小时运行验证脚本的任务
```

## 📈 验证成功标准

### 生产就绪检查表

系统被认为准备好生产使用，当：

- [ ] **100% 验证通过率**：所有自动化检查通过
- [ ] **响应时间** < 1 秒用于所有 API 调用
- [ ] **内存使用** < 200MB 在正常负载下
- [ ] **CPU 使用** < 10% 在正常负载下
- [ ] **无关键错误**在日志中
- [ ] **所有端点**返回预期响应
- [ ] **API 文档**可访问
- [ ] **数据库连接**稳定

### 高可用性标准

对于生产环境，还应验证：

- [ ] **故障转移**：服务在重启后自动恢复
- [ ] **负载测试**：系统处理并发请求
- [ ] **安全性**：API 密钥安全存储
- [ ] **监控**：日志记录和错误跟踪正常工作
- [ ] **备份**：配置和数据定期备份

## 🎯 验证报告

成功验证后，您的系统将具备：

- ✅ **完全功能的交易 API**
- ✅ **实时市场数据访问**
- ✅ **稳定的服务器性能**
- ✅ **全面的错误处理**
- ✅ **详细的日志记录**
- ✅ **交互式 API 文档**
- ✅ **健康监控系统**

**下一步：**
1. **开始交易**：查看 [API 使用示例](API使用示例.md)
2. **生产部署**：参见 [系统架构](系统架构.md)
3. **监控设置**：定期运行健康检查
4. **故障排除**：如有问题参见 [故障排除指南](故障排除指南.md)

---

**验证指南版本**：1.0.0  
**最后更新**：2025年1月  
**目标成功率**：>90%