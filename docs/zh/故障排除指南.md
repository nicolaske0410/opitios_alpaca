# 🔧 故障排除指南

这个全面的故障排除指南帮助您诊断和解决 Opitios Alpaca 交易服务的常见问题。

## 🚨 快速诊断工具

在深入具体问题之前，请尝试这些诊断工具：

```bash
# 运行综合设置验证器
python docs/scripts/setup_validator.py

# 检查系统健康状态
python docs/scripts/health_check.py

# 测试基本功能
python test_app.py
```

## 📋 常见问题索引

1. [安装和设置问题](#安装和设置问题)
2. [API 连接问题](#api-连接问题)
3. [身份验证错误](#身份验证错误)
4. [交易订单问题](#交易订单问题)
5. [市场数据问题](#市场数据问题)
6. [服务器和性能问题](#服务器和性能问题)
7. [配置问题](#配置问题)
8. [Python 环境问题](#python-环境问题)

---

## 安装和设置问题

### ❌ 问题："ModuleNotFoundError" 运行应用程序时

**症状：**
```
ModuleNotFoundError: No module named 'fastapi'
ModuleNotFoundError: No module named 'alpaca_trade_api'
```

**诊断：**
```bash
# 检查虚拟环境是否激活
echo $VIRTUAL_ENV  # Linux/Mac
echo %VIRTUAL_ENV%  # Windows

# 检查已安装的包
pip list
```

**解决方案：**

1. **激活虚拟环境**（关键）：
   ```bash
   # Windows
   venv\Scripts\activate
   
   # Linux/Mac
   source venv/bin/activate
   ```

2. **安装依赖**：
   ```bash
   pip install -r requirements.txt
   ```

3. **验证安装**：
   ```bash
   pip show fastapi alpaca-py
   ```

### ❌ 问题：安装期间"权限被拒绝"错误

**症状：**
```
ERROR: Could not install packages due to an EnvironmentError: [Errno 13] Permission denied
```

**解决方案：**

1. **使用虚拟环境**（推荐）：
   ```bash
   python -m venv venv
   venv\Scripts\activate  # Windows
   pip install -r requirements.txt
   ```

2. **用户安装**（替代方案）：
   ```bash
   pip install --user -r requirements.txt
   ```

### ❌ 问题：Python 版本兼容性错误

**症状：**
```
python: command not found
SyntaxError: invalid syntax (async/await)
```

**诊断：**
```bash
python --version
python3 --version
```

**解决方案：**
确保安装了 Python 3.8+：
```bash
# 如需要安装 Python 3.8+
# Windows: 从 python.org 下载
# Linux: sudo apt install python3.8
# Mac: brew install python@3.8

# 使用特定 Python 版本
python3.8 -m venv venv
```

---

## API 连接问题

### ❌ 问题："连接被拒绝"或"网络不可达"

**症状：**
```json
{
  "detail": "Could not connect to Alpaca API"
}
```

**诊断：**
```bash
# 测试基本连通性
curl -X GET "http://localhost:8081/api/v1/test-connection"

# 检查网络连通性
ping paper-api.alpaca.markets

# 验证防火墙/代理设置
curl -I https://paper-api.alpaca.markets
```

**解决方案：**

1. **检查互联网连接**：
   - 验证网络连通性
   - 如可能尝试使用不同网络

2. **防火墙/代理问题**：
   ```bash
   # 检查企业防火墙是否阻止 API 访问
   # 如需要配置代理
   export https_proxy=http://proxy.company.com:8080
   ```

3. **DNS 问题**：
   ```bash
   # 尝试使用 IP 地址而不是域名
   nslookup paper-api.alpaca.markets
   ```

### ❌ 问题：SSL/TLS 证书错误

**症状：**
```
SSLError: certificate verify failed
```

**解决方案：**

1. **更新证书**：
   ```bash
   pip install --upgrade certifi
   ```

2. **企业网络解决方案**：
   ```python
   # 仅在紧急情况下 - 不推荐用于生产环境
   import ssl
   ssl._create_default_https_context = ssl._create_unverified_context
   ```

---

## 身份验证错误

### ❌ 问题："无效的 API 凭据"或"401 未授权"

**症状：**
```json
{
  "detail": "Unauthorized: Invalid API credentials"
}
```

**诊断：**
```bash
# 检查环境变量
echo $ALPACA_API_KEY
echo $ALPACA_SECRET_KEY

# 验证 .env 文件
cat .env
```

**解决方案：**

1. **验证 API 密钥**：
   ```bash
   # 检查 .env 文件格式
   cat .env
   ```
   
   正确格式：
   ```env
   ALPACA_API_KEY=PKEIKZWFXA4BD1JMJAY3
   ALPACA_SECRET_KEY=your_actual_secret_key_here
   ALPACA_BASE_URL=https://paper-api.alpaca.markets
   ALPACA_PAPER_TRADING=true
   ```

2. **重新生成 API 密钥**：
   - 访问 [Alpaca 控制台](https://app.alpaca.markets/)
   - 导航到 API 密钥部分
   - 生成新的密钥对
   - 更新 .env 文件

3. **检查密钥格式**：
   - API 密钥应以"PK"（模拟）或"AK"（实盘）开头
   - 密钥应为 40 个字符长
   - 无空格或特殊字符

### ❌ 问题："超出速率限制"

**症状：**
```json
{
  "detail": "Rate limit exceeded. Please try again later."
}
```

**解决方案：**

1. **实施速率限制**：
   ```python
   import time
   
   # 在请求之间添加延迟
   time.sleep(1.0)  # 1 秒延迟
   ```

2. **批量请求**：
   ```bash
   # 使用批量端点而不是单个请求
   curl -X POST "http://localhost:8081/api/v1/stocks/quotes/batch"
   ```

---

## 交易订单问题

### ❌ 问题："购买力不足"

**症状：**
```json
{
  "detail": "Insufficient buying power for this order"
}
```

**诊断：**
```bash
# 检查账户购买力
curl -X GET "http://localhost:8081/api/v1/account"
```

**解决方案：**

1. **减少订单规模**：
   ```bash
   # 计算可负担的最大股数
   # 购买力 / 股价 = 最大股数
   ```

2. **检查账户状态**：
   - 验证账户已注资
   - 检查是否有待执行订单占用购买力
   - 查看保证金要求

### ❌ 问题："订单被交易所拒绝"

**症状：**
```json
{
  "status": "rejected",
  "reason": "Invalid order parameters"
}
```

**常见原因和解决方案：**

1. **市场时间**：
   ```bash
   # 检查市场是否开放
   date  # 验证当前时间
   # 市场时间：美东时间周一至周五上午 9:30 - 下午 4:00
   ```

2. **无效价格**：
   ```bash
   # 检查当前股价
   curl -X GET "http://localhost:8081/api/v1/stocks/AAPL/quote"
   
   # 确保限价在合理范围内（当前价格的 5% 以内）
   ```

3. **最小订单价值**：
   - Alpaca 要求最小 $1 订单价值
   - 检查：数量 × 价格 ≥ $1.00

### ❌ 问题：订单卡在"pending_new"状态

**症状：**
订单长时间保持待执行状态。

**诊断：**
```bash
# 检查订单状态
curl -X GET "http://localhost:8081/api/v1/orders?limit=5"

# 检查市场开放时间和条件
```

**解决方案：**

1. **取消并重试**：
   ```bash
   # 取消卡住的订单
   curl -X DELETE "http://localhost:8081/api/v1/orders/{order_id}"
   
   # 下新订单
   ```

2. **调整订单参数**：
   - 使用"day"而不是"gtc"作为有效期
   - 调整限价接近市价

---

## 市场数据问题

### ❌ 问题：有效股票代码"未找到报价数据"

**症状：**
```json
{
  "detail": "No quote data found for AAPL"
}
```

**诊断：**
```bash
# 使用已知活跃股票代码测试
curl -X GET "http://localhost:8081/api/v1/stocks/SPY/quote"

# 检查市场时间
date
```

**解决方案：**

1. **验证股票代码格式**：
   - 使用正确的股票代码（AAPL，不是 Apple）
   - 检查退市或暂停交易的股票

2. **市场时间**：
   - 实时数据在市场开放时间可用
   - 盘前/盘后数据可能有限

3. **数据订阅**：
   - 验证 Alpaca 账户有市场数据访问权限
   - 检查 Alpaca 控制台中的订阅状态

### ❌ 问题：延迟或过期的市场数据

**症状：**
报价显示旧的时间戳或似乎延迟。

**解决方案：**

1. **检查数据订阅**：
   - 验证实时数据订阅
   - 某些账户可能有 15 分钟延迟数据

2. **网络延迟**：
   ```bash
   # 测试到 Alpaca 的网络延迟
   ping paper-api.alpaca.markets
   ```

---

## 服务器和性能问题

### ❌ 问题："服务器启动失败"或立即关闭

**症状：**
```
ERROR: Error loading ASGI app. Could not import module "main".
[ERROR] Application startup failed.
```

**诊断：**
```bash
# 检查 Python 路径和导入
python -c "import app.routes"
python -c "import config"

# 检查语法错误
python -m py_compile main.py
```

**解决方案：**

1. **检查文件结构**：
   ```
   opitios_alpaca/
   ├── app/
   │   ├── __init__.py
   │   ├── routes.py
   │   └── models.py
   ├── main.py
   └── config.py
   ```

2. **修复导入错误**：
   ```python
   # 验证所有导入都正确
   from app.routes import router  # 检查此路径
   from config import settings    # 检查此路径
   ```

### ❌ 问题：高内存使用或性能缓慢

**症状：**
- 服务器变得无响应
- 高 CPU/内存使用
- API 响应缓慢

**诊断：**
```bash
# 监控系统资源
top
htop  # 如果可用

# 检查 Python 进程
ps aux | grep python
```

**解决方案：**

1. **重启服务器**：
   ```bash
   # 停止服务器（Ctrl+C）
   # 重启
   python main.py
   ```

2. **检查内存泄漏**：
   ```python
   # 添加内存监控
   import psutil
   import os
   
   process = psutil.Process(os.getpid())
   print(f"Memory usage: {process.memory_info().rss / 1024 / 1024:.2f} MB")
   ```

### ❌ 问题：端口已被使用

**症状：**
```
OSError: [Errno 48] Address already in use
```

**解决方案：**

1. **查找并终止进程**：
   ```bash
   # Windows
   netstat -ano | findstr :8081
   taskkill /PID <process_id> /F
   
   # Linux/Mac
   lsof -i :8081
   kill -9 <process_id>
   ```

2. **使用不同端口**：
   ```bash
   # 在 .env 或命令行中更改端口
   python main.py --port 8082
   ```

---

## 配置问题

### ❌ 问题：环境变量未加载

**症状：**
```
ValueError: ALPACA_API_KEY environment variable is required
```

**诊断：**
```bash
# 检查 .env 文件存在和格式
ls -la .env
cat .env

# 测试环境加载
python -c "from config import settings; print(settings.alpaca_api_key)"
```

**解决方案：**

1. **验证 .env 文件**：
   ```env
   # 正确格式（= 周围无空格）
   ALPACA_API_KEY=PKEIKZWFXA4BD1JMJAY3
   ALPACA_SECRET_KEY=your_secret_key
   
   # 错误格式
   ALPACA_API_KEY = PKEIKZWFXA4BD1JMJAY3  # 无空格！
   ```

2. **检查文件位置**：
   ```bash
   # .env 应在项目根目录
   ls -la .env
   pwd  # 应在 opitios_alpaca 目录中
   ```

### ❌ 问题：数据库连接错误

**症状：**
```
sqlite3.OperationalError: database is locked
```

**解决方案：**

1. **检查文件权限**：
   ```bash
   ls -la users.db
   chmod 644 users.db  # 如需要
   ```

2. **关闭现有连接**：
   ```bash
   # 重启服务器以关闭数据库连接
   # 检查多个服务器实例
   ```

---

## Python 环境问题

### ❌ 问题：虚拟环境工作不正常

**症状：**
- 包安装到全局而不是 venv
- 使用了错误的 Python 版本
- 尽管安装了包但仍有导入错误

**诊断：**
```bash
# 检查虚拟环境状态
which python
which pip
echo $VIRTUAL_ENV  # 应显示 venv 路径

# 检查 Python 版本
python --version
```

**解决方案：**

1. **重新创建虚拟环境**：
   ```bash
   # 删除旧的 venv
   rm -rf venv
   
   # 创建新的 venv
   python3 -m venv venv
   
   # 激活
   venv\Scripts\activate  # Windows
   source venv/bin/activate  # Linux/Mac
   
   # 安装依赖
   pip install -r requirements.txt
   ```

2. **验证激活**：
   ```bash
   # 激活后，提示符应显示 (venv)
   # 示例：(venv) user@machine:~/opitios_alpaca$
   ```

### ❌ 问题：包版本冲突

**症状：**
```
ERROR: pip's dependency resolver does not currently consider all the versions that satisfy the requirements
```

**解决方案：**

1. **清理安装**：
   ```bash
   pip uninstall -r requirements.txt -y
   pip install -r requirements.txt
   ```

2. **更新 pip**：
   ```bash
   pip install --upgrade pip
   pip install --upgrade setuptools wheel
   ```

---

## 🚨 紧急故障排除

### 当一切都不工作时

1. **完全重置**：
   ```bash
   # 保存您的 .env 文件
   cp .env .env.backup
   
   # 全新开始
   rm -rf venv
   python3 -m venv venv
   venv\Scripts\activate
   pip install --upgrade pip
   pip install -r requirements.txt
   
   # 恢复配置
   cp .env.backup .env
   
   # 测试
   python test_app.py
   ```

2. **最小测试**：
   ```bash
   # 测试基本 Python 功能
   python -c "print('Python works')"
   
   # 测试 FastAPI 安装
   python -c "import fastapi; print('FastAPI works')"
   
   # 测试 Alpaca API
   python -c "import alpaca_trade_api; print('Alpaca API works')"
   ```

### 获取帮助

1. **收集调试信息**：
   ```bash
   # 运行综合诊断
   python docs/scripts/setup_validator.py > debug_info.txt 2>&1
   
   # 系统信息
   python --version >> debug_info.txt
   pip list >> debug_info.txt
   ```

2. **检查日志**：
   ```bash
   # 检查应用程序日志
   tail -f logs/alpaca_service.log
   
   # 如需要检查系统日志
   ```

3. **联系支持**：
   - 包含 debug_info.txt
   - 描述确切的错误消息
   - 列出重现问题的步骤

---

## ✅ 预防最佳实践

### 定期维护

1. **保持依赖更新**：
   ```bash
   pip list --outdated
   pip install --upgrade -r requirements.txt
   ```

2. **监控日志**：
   ```bash
   # 定期检查日志
   tail logs/alpaca_service.log
   ```

3. **定期测试**：
   ```bash
   # 定期运行测试
   python test_app.py
   pytest
   ```

### 开发最佳实践

1. **始终使用虚拟环境**
2. **保持 .env 文件安全和更新**
3. **首先在模拟交易中测试更改**
4. **监控 API 速率限制**
5. **实施适当的错误处理**

---

## 📞 支持资源

### 自助工具
- **设置验证器**：`python docs/scripts/setup_validator.py`
- **健康检查**：`python docs/scripts/health_check.py`
- **配置助手**：`python docs/scripts/config_helper.py`

### 文档
- **快速开始**：[快速开始指南](快速开始指南.md)
- **API 参考**：[API 使用示例](API使用示例.md)
- **架构**：[系统架构](系统架构.md)

### 外部资源
- [Alpaca API 文档](https://alpaca.markets/docs/)
- [FastAPI 文档](https://fastapi.tiangolo.com/)
- [Python 虚拟环境指南](https://docs.python.org/3/tutorial/venv.html)

---

**故障排除指南版本**：1.0.0  
**最后更新**：2025年1月  
**下一步**：[安装验证](安装验证.md)